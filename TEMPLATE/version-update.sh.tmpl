#!/bin/bash
# {{ .CreationWarning }}
# {{ .CreationInfo }}
{{ $version := FindInMap .Json.versions .Env.GB_VERSION }}
{{ if not $version }}
# No version found in gearbox.json

{{ else if not .Json.meta.name }}
# No name found in gearbox.json

{{ else }}
VERSION="{{ .Env.GB_VERSION }}"
export VERSION

if [ ! -d "${VERSION}" ]
then
	echo "Gearbox: Release version directory ${VERSION} doesn't exist."
	exit 1
fi

################################################################################
# Maybe we have rsync, maybe we don't.
mkdir "${VERSION}"

RSYNC="$(which rsync)"
if [ "${RSYNC}" != "" ]
then
	rsync -HvaxP TEMPLATE/version/ "${VERSION}/"
else
	tar cf - -C TEMPLATE/version . | tar xvf - -C "${VERSION}"
fi

################################################################################
TMPLFILES="TEMPLATE/version/.env.tmpl TEMPLATE/version/DockerfileRuntime.tmpl"
for file in ${TMPLFILES}
do
	OUTFILE="$(echo -n "${file}" | sed 's/JSON_NAME/{{ $.Json.meta.name }}/')"
	if [ "${file}" != "${OUTFILE}" ]
	then
		mv "${file}" "${OUTFILE}"
	fi

	echo "Gearbox: Processing ${OUTFILE}"
	{{ $.ExecName }} -json "{{ $.JsonFile.Dir }}/{{ $.JsonFile.Name }}" -create "${OUTFILE}"
done
{{ end }}
# END
